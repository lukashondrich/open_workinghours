---
import LayoutDE from '../../layouts/LayoutDE.astro';
import InteractiveMap from '../../components/InteractiveMap/InteractiveMap.tsx';

// API base URL - use environment variable in production
const API_BASE = import.meta.env.PUBLIC_API_URL || 'https://api.openworkinghours.org';
---

<LayoutDE
  title="Abdeckungs-Dashboard"
  description="Verfolgen Sie das Wachstum unabhängiger Arbeitszeitdaten im Gesundheitswesen in Deutschland. Privacy by Design, von der Community getragen."
>
  <!-- Hero Section -->
  <section class="bg-gradient-to-b from-teal-50 to-white py-12 sm:py-16">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 text-center">
      <span class="inline-block px-3 py-1 text-xs font-medium text-teal-700 bg-teal-100 rounded-full mb-4">
        Live-Abdeckung (Preview)
      </span>
      <h1 class="text-stone-900 mb-4">
        Arbeitszeiten im Gesundheitswesen<br class="hidden sm:block" /> in Deutschland sichtbar machen
      </h1>
      <p class="text-xl text-stone-600 max-w-2xl mx-auto mb-8">
        Unabhängige, aggregierte Evidenz für bessere Arbeitsbedingungen.<br />
        Privacy by Design. Von der Community getragen.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="#download" class="btn-primary">
          App herunterladen
        </a>
        <a href="#method" class="btn-secondary">
          So funktioniert es
        </a>
      </div>
    </div>
  </section>

  <!-- Coverage Map Section -->
  <section class="py-12 sm:py-16" id="coverage">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <h2 class="text-stone-900 mb-2">Abdeckungsstatus</h2>
      <p class="text-stone-600 mb-8">
        Sehen Sie, welche Regionen die Schutzschwelle (k=11) erreichen.
      </p>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Map Container -->
        <div class="lg:col-span-2 bg-stone-50 rounded-xl p-6 min-h-[400px]" id="map-container">
          <InteractiveMap client:load locale="de" />
        </div>

        <!-- Stats Sidebar -->
        <div class="space-y-4">
          <div class="bg-white border border-stone-200 rounded-xl p-6">
            <h3 class="text-sm font-medium text-stone-500 uppercase tracking-wide mb-1">Aktive Beitragende</h3>
            <p class="text-3xl font-semibold text-stone-900" id="contributors-count">--</p>
            <p class="text-sm text-stone-500">in den letzten 30 Tagen</p>
          </div>

          <div class="bg-white border border-stone-200 rounded-xl p-6">
            <h3 class="text-sm font-medium text-stone-500 uppercase tracking-wide mb-1">Bestätigte Schichten</h3>
            <p class="text-3xl font-semibold text-stone-900" id="shifts-count">--</p>
            <p class="text-sm text-stone-500">in den letzten 30 Tagen</p>
          </div>

          <div class="bg-white border border-stone-200 rounded-xl p-6">
            <h3 class="text-sm font-medium text-stone-500 uppercase tracking-wide mb-1">Bundesländer</h3>
            <p class="text-3xl font-semibold text-stone-900" id="states-count">--</p>
            <p class="text-sm text-stone-500">nahe an der Schwelle</p>
          </div>

          <div class="bg-teal-50 border border-teal-200 rounded-xl p-4">
            <p class="text-sm text-teal-800">
              <strong>Schutzschwelle (k=11):</strong> Statistiken zeigen wir nur ab 11 Beitragenden pro Gruppe.
            </p>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- What Becomes Possible Section -->
  <section class="py-12 sm:py-16 bg-stone-50" id="insights">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <h2 class="text-stone-900 mb-2">Was wir veröffentlichen werden</h2>
      <p class="text-stone-600 mb-8">
        Sobald Regionen die Schutzschwelle (k=11) erreichen, veröffentlichen wir aggregierte Auswertungen.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Overtime Trends -->
        <div class="bg-white rounded-xl p-6 border border-stone-200 opacity-60">
          <div class="h-32 bg-stone-100 rounded-lg mb-4 flex items-center justify-center">
            <svg class="w-12 h-12 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <h3 class="font-semibold text-stone-900 mb-2">Überstunden-Trends</h3>
          <p class="text-sm text-stone-600 mb-4">Durchschnittliche wöchentliche Überstunden nach Region und Fachgebiet.</p>
          <span class="inline-flex items-center gap-1 text-xs font-medium text-amber-700 bg-amber-100 px-2 py-1 rounded-full">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
            </svg>
            Freigeschaltet ab 11 Beitragenden
          </span>
        </div>

        <!-- Planned vs Actual -->
        <div class="bg-white rounded-xl p-6 border border-stone-200 opacity-60">
          <div class="h-32 bg-stone-100 rounded-lg mb-4 flex items-center justify-center">
            <svg class="w-12 h-12 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <h3 class="font-semibold text-stone-900 mb-2">Geplant vs. tatsächlich</h3>
          <p class="text-sm text-stone-600 mb-4">Geplante Stunden vs. reale Arbeitszeit.</p>
          <span class="inline-flex items-center gap-1 text-xs font-medium text-amber-700 bg-amber-100 px-2 py-1 rounded-full">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
            </svg>
            Freigeschaltet ab 11 Beitragenden
          </span>
        </div>

        <!-- Regional Comparison -->
        <div class="bg-white rounded-xl p-6 border border-stone-200 opacity-60">
          <div class="h-32 bg-stone-100 rounded-lg mb-4 flex items-center justify-center">
            <svg class="w-12 h-12 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="font-semibold text-stone-900 mb-2">Regionaler Vergleich</h3>
          <p class="text-sm text-stone-600 mb-4">Wie schneidet Ihre Region im Vergleich zu anderen ab?</p>
          <span class="inline-flex items-center gap-1 text-xs font-medium text-amber-700 bg-amber-100 px-2 py-1 rounded-full">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
            </svg>
            Freigeschaltet ab 11 Beitragenden
          </span>
        </div>
      </div>

      <div class="text-center mt-8">
        <a href="#download" class="btn-primary">
          Helfen Sie mit, Auswertungen für Ihre Region freizuschalten
        </a>
      </div>
    </div>
  </section>

  <!-- Trust & Method Section -->
  <section class="py-12 sm:py-16" id="method">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <h2 class="text-stone-900 mb-2">Privacy by Design: So schützen wir Ihre Daten</h2>
      <p class="text-stone-600 mb-8">
        Datenschutz ist auf Systemebene eingebaut – nicht als nachträglicher Zusatz.
      </p>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- K-Anonymity Visual -->
        <div class="bg-teal-50 rounded-xl p-8">
          <div class="flex items-center justify-center gap-4 mb-6">
            <div class="flex flex-wrap justify-center gap-1 max-w-[140px]">
              {[...Array(11)].map(() => (
                <svg class="w-6 h-6 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                </svg>
              ))}
            </div>

            <svg class="w-8 h-8 text-teal-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>

            <div class="bg-teal-600 text-white rounded-lg p-3">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            </div>
          </div>

          <h3 class="text-lg font-semibold text-teal-900 text-center mb-2">K-Anonymität (k=11)</h3>
          <p class="text-teal-800 text-center">
            Veröffentlichung nur, wenn mindestens <strong>11 Personen</strong> zu einer Statistik beitragen. Einzelbeiträge sind nicht unterscheidbar.
          </p>
        </div>

        <!-- Privacy Checklist -->
        <div class="space-y-4">
          <div class="flex gap-3 items-start">
            <div class="flex-shrink-0 w-6 h-6 bg-teal-100 rounded-full flex items-center justify-center">
              <svg class="w-4 h-4 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <p class="font-medium text-stone-900">Kein Arbeitgeberzugriff</p>
              <p class="text-sm text-stone-600">Kein Arbeitgeber-Tool. Keine Weitergabe individueller Daten an Arbeitgeber.</p>
            </div>
          </div>

          <div class="flex gap-3 items-start">
            <div class="flex-shrink-0 w-6 h-6 bg-teal-100 rounded-full flex items-center justify-center">
              <svg class="w-4 h-4 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <p class="font-medium text-stone-900">GPS bleibt auf dem Gerät</p>
              <p class="text-sm text-stone-600">Standortdaten werden lokal für Geofencing verwendet; keine Übertragung exakter GPS-Koordinaten.</p>
            </div>
          </div>

          <div class="flex gap-3 items-start">
            <div class="flex-shrink-0 w-6 h-6 bg-teal-100 rounded-full flex items-center justify-center">
              <svg class="w-4 h-4 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <p class="font-medium text-stone-900">E-Mail nur gehasht gespeichert (One-way Hash)</p>
              <p class="text-sm text-stone-600">Zur Kontointegrität speichern wir ausschließlich einen One-way Hash; die E-Mail-Adresse selbst wird nicht gespeichert.</p>
            </div>
          </div>

          <div class="flex gap-3 items-start">
            <div class="flex-shrink-0 w-6 h-6 bg-teal-100 rounded-full flex items-center justify-center">
              <svg class="w-4 h-4 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <p class="font-medium text-stone-900">Hosting in Deutschland (EU)</p>
              <p class="text-sm text-stone-600">Gehostet in Deutschland (EU), keine Datenübertragung außerhalb der EU.</p>
            </div>
          </div>

          <div class="flex gap-3 items-start">
            <div class="flex-shrink-0 w-6 h-6 bg-teal-100 rounded-full flex items-center justify-center">
              <svg class="w-4 h-4 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <p class="font-medium text-stone-900">Löschung jederzeit möglich (DSGVO Art. 17)</p>
              <p class="text-sm text-stone-600">Vollständige Kontolöschung in der App.</p>
            </div>
          </div>

          <div class="mt-6 pt-4 border-t border-stone-200">
            <a href="/de/privacy" class="text-teal-600 hover:text-teal-700 text-sm font-medium">
              Vollständige Datenschutzgrundsätze lesen &rarr;
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- For Institutions Section -->
  <section class="py-12 sm:py-16 bg-stone-50" id="institutions">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Left: Info -->
        <div>
          <h2 class="text-stone-900 mb-4">Für Gewerkschaften & Berufsverbände</h2>
          <p class="text-stone-600 mb-6">
            Open Working Hours liefert unabhängige, aggregierte Evidenz – nutzbar für Tarifverhandlungen, Forschung und Interessenvertretung.
          </p>

          <ul class="space-y-3 text-stone-700">
            <li class="flex gap-3">
              <span class="text-teal-600 mt-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </span>
              <span>Methodik mit Datenschutzexpertise entwickelt</span>
            </li>
            <li class="flex gap-3">
              <span class="text-teal-600 mt-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </span>
              <span>K-Anonymität als Mindeststandard (k=11), orientiert an EMA/Health Canada Leitlinien zur Veröffentlichung</span>
            </li>
            <li class="flex gap-3">
              <span class="text-teal-600 mt-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </span>
              <span>Differential Privacy (statistisches Rauschen)</span>
            </li>
            <li class="flex gap-3">
              <span class="text-teal-600 mt-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </span>
              <span>Open-Source-Infrastruktur</span>
            </li>
          </ul>
        </div>

        <!-- Right: Contact Form -->
        <div class="bg-white rounded-xl p-6 border border-stone-200">
          <h3 class="font-semibold text-stone-900 mb-4">Briefing anfordern</h3>

          <form id="institution-form" class="space-y-4">
            <div>
              <label for="name" class="block text-sm font-medium text-stone-700 mb-1">Name</label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
              />
            </div>

            <div>
              <label for="organization" class="block text-sm font-medium text-stone-700 mb-1">Organisation</label>
              <input
                type="text"
                id="organization"
                name="organization"
                required
                class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
              />
            </div>

            <div>
              <label for="role" class="block text-sm font-medium text-stone-700 mb-1">Rolle</label>
              <select
                id="role"
                name="role"
                required
                class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
              >
                <option value="">Bitte auswählen...</option>
                <option value="union">Gewerkschaft/Berufsverband</option>
                <option value="researcher">Wissenschaft/Forschung</option>
                <option value="press">Presse/Medien</option>
                <option value="other">Sonstiges</option>
              </select>
            </div>

            <div>
              <label for="email" class="block text-sm font-medium text-stone-700 mb-1">E-Mail</label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
              />
            </div>

            <div>
              <label for="message" class="block text-sm font-medium text-stone-700 mb-1">Nachricht</label>
              <textarea
                id="message"
                name="message"
                rows="3"
                required
                class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                placeholder="Erzählen Sie uns von Ihrem Interesse an den Daten..."
              ></textarea>
            </div>

            <div class="flex items-start gap-2">
              <input
                type="checkbox"
                id="privacy-consent"
                name="privacy-consent"
                required
                class="mt-1"
              />
              <label for="privacy-consent" class="text-sm text-stone-600">
                Ich habe die <a href="/de/datenschutzerklaerung" class="text-teal-600 hover:underline">Datenschutzerklärung</a> gelesen und stimme zu.
              </label>
            </div>

            <button
              type="submit"
              class="w-full btn-primary"
              id="submit-btn"
            >
              Anfrage senden
            </button>

            <div id="form-status" class="text-sm text-center hidden"></div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Download & Share Section -->
  <section class="py-12 sm:py-16" id="download">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 text-center">
      <h2 class="text-stone-900 mb-4">Helfen Sie, Transparenz aufzubauen</h2>
      <p class="text-stone-600 mb-8 max-w-xl mx-auto">
        Jeder Beitrag hilft, ein belastbares Bild der Arbeitsbedingungen im Gesundheitswesen aufzubauen – datenschutzkonform und aggregiert.
      </p>

      <!-- App Store Button -->
      <div class="mb-8">
        <a
          href="#"
          class="inline-flex items-center gap-3 bg-stone-900 text-white px-6 py-3 rounded-xl hover:bg-stone-800 transition-colors"
          id="app-store-btn"
        >
          <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
          </svg>
          <div class="text-left">
            <div class="text-xs">Im App Store</div>
            <div class="text-lg font-semibold">laden</div>
          </div>
        </a>
        <p class="text-sm text-stone-500 mt-2">TestFlight: bald verfügbar</p>
      </div>

      <!-- Share Links -->
      <div class="border-t border-stone-200 pt-8">
        <p class="text-sm font-medium text-stone-700 mb-4">Diese Seite teilen</p>
        <div class="flex justify-center gap-4">
          <a
            href="#"
            class="p-3 bg-stone-100 rounded-full hover:bg-stone-200 transition-colors"
            title="Auf WhatsApp teilen"
            id="share-whatsapp"
          >
            <svg class="w-5 h-5 text-stone-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
          </a>
          <a
            href="#"
            class="p-3 bg-stone-100 rounded-full hover:bg-stone-200 transition-colors"
            title="Auf Twitter/X teilen"
            id="share-twitter"
          >
            <svg class="w-5 h-5 text-stone-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </a>
          <a
            href="#"
            class="p-3 bg-stone-100 rounded-full hover:bg-stone-200 transition-colors"
            title="Auf LinkedIn teilen"
            id="share-linkedin"
          >
            <svg class="w-5 h-5 text-stone-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          </a>
          <button
            class="p-3 bg-stone-100 rounded-full hover:bg-stone-200 transition-colors"
            title="Link kopieren"
            id="copy-link"
          >
            <svg class="w-5 h-5 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </section>
</LayoutDE>

<style>
  .state-path {
    fill: #d6d3d1;
    stroke: #ffffff;
    stroke-width: 2;
    cursor: pointer;
    transition: fill 0.2s ease, transform 0.1s ease;
  }

  .state-path:hover {
    transform: scale(1.02);
    transform-origin: center;
  }

  .state-path.building {
    fill: #fbbf24;
  }

  .state-path.available {
    fill: #14b8a6;
  }
</style>

<script define:vars={{ API_BASE }}>
  // Check for Datawrapper embed and load it if available
  async function loadDatawrapperMap() {
    try {
      const response = await fetch(`${API_BASE}/dashboard/map-embed`);
      if (!response.ok) return false;
      const data = await response.json();

      if (data.enabled && data.embed_url) {
        const container = document.getElementById('datawrapper-map');
        const fallback = document.getElementById('germany-map');

        if (container) {
          const iframe = document.createElement('iframe');
          iframe.title = 'Abdeckungskarte Gesundheitswesen';
          iframe.setAttribute('aria-label', 'Karte');
          iframe.src = data.embed_url;
          iframe.scrolling = 'no';
          iframe.frameBorder = '0';
          iframe.style.cssText = 'width: 0; min-width: 100% !important; border: none;';
          iframe.height = '500';
          iframe.dataset.external = '1';

          container.appendChild(iframe);
          container.classList.remove('hidden');

          if (fallback) {
            fallback.classList.add('hidden');
          }

          window.addEventListener('message', function(e) {
            if (e.data['datawrapper-height'] !== undefined) {
              const heights = e.data['datawrapper-height'];
              for (const chartId in heights) {
                if (iframe.contentWindow === e.source) {
                  iframe.style.height = heights[chartId] + 'px';
                }
              }
            }
          });

          return true;
        }
      }
    } catch (error) {
      console.error('Error loading Datawrapper map:', error);
    }
    return false;
  }

  async function loadCoverageData() {
    try {
      const response = await fetch(`${API_BASE}/dashboard/coverage`);
      if (!response.ok) throw new Error('Failed to fetch coverage data');
      const data = await response.json();

      const svgMap = document.getElementById('germany-map');
      if (svgMap && !svgMap.classList.contains('hidden')) {
        data.states.forEach(state => {
          const el = document.getElementById(state.state_code);
          if (el) {
            el.classList.remove('building', 'available');
            if (state.status === 'building') {
              el.classList.add('building');
            } else if (state.status === 'available') {
              el.classList.add('available');
            }
            el.setAttribute('data-contributors', state.contributors_range);
            el.setAttribute('data-status', state.status);
          }
        });
      }
    } catch (error) {
      console.error('Error loading coverage data:', error);
    }
  }

  async function loadActivityData() {
    try {
      const response = await fetch(`${API_BASE}/dashboard/activity`);
      if (!response.ok) throw new Error('Failed to fetch activity data');
      const data = await response.json();

      document.getElementById('contributors-count').textContent = data.contributors_range;
      document.getElementById('shifts-count').textContent = data.shifts_confirmed.toString();
      document.getElementById('states-count').textContent = `${data.states_building + data.states_available}/16`;
    } catch (error) {
      console.error('Error loading activity data:', error);
    }
  }

  document.getElementById('institution-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target;
    const submitBtn = document.getElementById('submit-btn');
    const statusEl = document.getElementById('form-status');

    const formData = {
      name: form.name.value,
      organization: form.organization.value,
      role: form.role.value,
      email: form.email.value,
      message: form.message.value,
    };

    submitBtn.disabled = true;
    submitBtn.textContent = 'Wird gesendet...';

    try {
      const response = await fetch(`${API_BASE}/dashboard/contact`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      const result = await response.json();

      if (result.success) {
        statusEl.textContent = 'Vielen Dank! Wir werden uns bald melden.';
        statusEl.className = 'text-sm text-center text-teal-600';
        form.reset();
      } else {
        statusEl.textContent = 'Etwas ist schief gelaufen. Bitte versuchen Sie es erneut.';
        statusEl.className = 'text-sm text-center text-red-600';
      }
    } catch (error) {
      statusEl.textContent = 'Netzwerkfehler. Bitte versuchen Sie es erneut.';
      statusEl.className = 'text-sm text-center text-red-600';
    }

    statusEl.classList.remove('hidden');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Anfrage senden';
  });

  const shareUrl = window.location.href;
  const shareText = 'Arbeitszeiten im Gesundheitswesen in Deutschland sichtbar machen – Unabhängige, datenschutzkonforme Daten zu Arbeitsbedingungen.';

  document.getElementById('share-whatsapp')?.addEventListener('click', (e) => {
    e.preventDefault();
    window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`, '_blank');
  });

  document.getElementById('share-twitter')?.addEventListener('click', (e) => {
    e.preventDefault();
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
  });

  document.getElementById('share-linkedin')?.addEventListener('click', (e) => {
    e.preventDefault();
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`, '_blank');
  });

  document.getElementById('copy-link')?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(shareUrl);
      alert('Link in die Zwischenablage kopiert!');
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  });

  document.addEventListener('DOMContentLoaded', async () => {
    const datawrapperLoaded = await loadDatawrapperMap();
    if (!datawrapperLoaded) {
      loadCoverageData();
    }
    loadActivityData();
  });
</script>
