name: e2e-ios

on:
  workflow_dispatch:

jobs:
  detox-ios:
    runs-on: macos-14
    env:
      SIMULATOR_NAME: iPhone 15
      TEST_PRIVACY_NOISE_SEED: 12345
      EXPO_PUBLIC_SUBMISSION_BASE_URL: http://localhost:8000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.1
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install watchman (required by Detox)
        run: brew install watchman

      - name: Ensure CocoaPods
        run: sudo gem install cocoapods

      - name: Install npm dependencies
        run: npm ci
        working-directory: mobile-app

      - name: Install pods (preflight)
        run: npx pod-install --non-interactive
        working-directory: mobile-app

      - name: Run Detox (seeded flow)
        run: npm run e2e:ios
        working-directory: mobile-app
